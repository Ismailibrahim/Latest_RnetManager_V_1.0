# Project Memory & Development Guidelines
## Always Follow These Rules When Working on This Project

> **This file serves as persistent memory for AI assistants working on this project. Always read and follow these guidelines.**

## üìç Working Directories

**Project Root**: `/var/www/rentapplicaiton/`  
**Backend Working Directory**: `/var/www/rentapplicaiton/backend`  
**Frontend Working Directory**: `/var/www/rentapplicaiton/frontend`

> **Always use these paths when referencing files or running commands.**

### Quick Navigation Commands
```bash
# Navigate to project root
cd /var/www/rentapplicaiton/

# Navigate to backend (Laravel)
cd /var/www/rentapplicaiton/backend

# Navigate to frontend (Next.js)
cd /var/www/rentapplicaiton/frontend

# Navigate to backend logs
cd /var/www/rentapplicaiton/backend/storage/logs
```

---

## üî¥ CRITICAL: File Permissions & Root User

### The Problem
- **PHP-FPM runs as `www-data` user**
- **Files created by `root` cannot be written by `www-data`**
- **This causes 500 errors and breaks login/API functionality**

### Golden Rules

1. **NEVER run Laravel commands as root**
   ```bash
   # ‚ùå NEVER DO THIS
   sudo php artisan migrate
   sudo php artisan cache:clear
   
   # ‚úÖ ALWAYS DO THIS
   sudo -u www-data php artisan migrate
   sudo -u www-data php artisan cache:clear
   ```

2. **NEVER create/edit files in storage/ as root**
   ```bash
   # ‚ùå NEVER DO THIS
   sudo nano storage/logs/file.log
   sudo touch storage/logs/file.log
   
   # ‚úÖ ALWAYS DO THIS
   sudo -u www-data nano storage/logs/file.log
   sudo -u www-data touch storage/logs/file.log
   ```

3. **ALWAYS fix permissions after working as root**
   ```bash
   # After ANY work as root, run:
   sudo /var/www/rentapplicaiton/backend/fix-permissions.sh
   
   # Or use the helper command:
   after-root-work
   ```

4. **Check ownership before finishing work**
   ```bash
   check-laravel-owner
   ```

### When Working as Root
- **Before**: Check current state with `check-laravel-owner`
- **During**: Use `sudo -u www-data` for all Laravel/application commands
- **After**: **ALWAYS** run `after-root-work` or `fix-permissions.sh`

### Helper Commands Available
- `check-laravel-owner` - Check for wrong ownership
- `after-root-work` - Fix permissions after root work
- `/var/www/rentapplicaiton/backend/fix-permissions.sh` - Manual fix script

---

## üõ°Ô∏è Error Handling Best Practices

### Middleware & Logging
- **NEVER let logging failures break requests**
- **ALWAYS wrap logging in try-catch blocks**
- **Gracefully degrade** - fall back to default logging if specific channel fails

### Example Pattern
```php
try {
    Log::channel('probe')->info('message', $context);
} catch (\Throwable $logError) {
    // Don't break the request - log to default channel
    \Log::warning('Probe logging failed: ' . $logError->getMessage());
}
```

### API Error Responses
- **ALWAYS provide detailed error messages** (in debug mode)
- **Extract error details from API responses** before showing generic messages
- **Handle network errors separately** from API errors
- **Log full error details** for debugging

---

## üìÅ Project Structure & Working Directories

### Project Root
- **Main Project Path**: `/var/www/rentapplicaiton/`
- **Always start from here when navigating the project**

### Backend
- **Working Directory**: `/var/www/rentapplicaiton/backend`
- **Framework**: Laravel
- **PHP Version**: 8.3
- **Web Server**: PHP-FPM (runs as `www-data`)
- **Reverse Proxy**: Nginx
- **Artisan Path**: `/var/www/rentapplicaiton/backend/artisan`

### Frontend
- **Working Directory**: `/var/www/rentapplicaiton/frontend`
- **Framework**: Next.js 16.0.8 (Turbopack)
- **Process Manager**: PM2 (`rentapp-frontend`)
- **Port**: 3000
- **Package Manager**: npm

### Important Directories
- **Backend Storage**: `/var/www/rentapplicaiton/backend/storage`
- **Backend Logs**: `/var/www/rentapplicaiton/backend/storage/logs`
- **Backend Config**: `/var/www/rentapplicaiton/backend/config`
- **Backend App**: `/var/www/rentapplicaiton/backend/app`
- **Backend Routes**: `/var/www/rentapplicaiton/backend/routes`
- **Frontend App**: `/var/www/rentapplicaiton/frontend/app`
- **Frontend Components**: `/var/www/rentapplicaiton/frontend/components`
- **Fix Script**: `/var/www/rentapplicaiton/backend/fix-permissions.sh`

### Quick Navigation Commands
```bash
# Navigate to project root
cd /var/www/rentapplicaiton/

# Navigate to backend
cd /var/www/rentapplicaiton/backend

# Navigate to frontend
cd /var/www/rentapplicaiton/frontend

# Navigate to logs
cd /var/www/rentapplicaiton/backend/storage/logs
```

---

## üîß Common Tasks & Commands

### Fix Permissions (After Root Work)
```bash
sudo /var/www/rentapplicaiton/backend/fix-permissions.sh
# OR
after-root-work
```

### Check File Ownership
```bash
check-laravel-owner
# OR
find /var/www/rentapplicaiton/backend/storage ! -user www-data -ls
```

### Restart Services
```bash
# Frontend
pm2 restart rentapp-frontend

# Backend PHP-FPM
sudo systemctl restart php8.3-fpm

# Nginx
sudo systemctl restart nginx
```

### Run Laravel Commands
```bash
# ALWAYS as www-data
# From backend directory:
cd /var/www/rentapplicaiton/backend
sudo -u www-data php artisan [command]

# Or from anywhere:
sudo -u www-data php /var/www/rentapplicaiton/backend/artisan [command]
```

### Navigate to Working Directories
```bash
# Backend working directory
cd /var/www/rentapplicaiton/backend

# Frontend working directory
cd /var/www/rentapplicaiton/frontend

# Project root
cd /var/www/rentapplicaiton/
```

---

## üö® Known Issues & Solutions

### Issue: Login Fails with 500 Error
**Cause**: Log file permission error  
**Solution**: 
1. Run `check-laravel-owner` to identify files
2. Run `after-root-work` to fix
3. Verify: `sudo -u www-data touch /var/www/rentapplicaiton/backend/storage/logs/test.log && rm /var/www/rentapplicaiton/backend/storage/logs/test.log`

### Issue: "Failed to fetch login logs"
**Cause**: API returns 500 error  
**Solution**: Check backend logs, verify permissions, ensure graceful error handling in middleware

---

## üìù Code Standards

### Error Handling
- ‚úÖ Use try-catch for all logging operations
- ‚úÖ Provide detailed error messages in debug mode
- ‚úÖ Never let non-critical operations break requests
- ‚úÖ Log errors to default channel if specific channel fails

### File Operations
- ‚úÖ Always check if file exists before operations
- ‚úÖ Use null-safe operators (`?->`) for optional operations
- ‚úÖ Handle null relationships gracefully

### API Responses
- ‚úÖ Extract detailed error messages from responses
- ‚úÖ Provide specific error messages based on HTTP status codes
- ‚úÖ Log full error details for debugging
- ‚úÖ Handle network errors separately

---

## üîç Debugging Checklist

When investigating issues:

1. **Check file permissions**
   ```bash
   check-laravel-owner
   ls -la /var/www/rentapplicaiton/backend/storage/logs/
   ```

2. **Check service status**
   ```bash
   pm2 status
   sudo systemctl status php8.3-fpm
   sudo systemctl status nginx
   ```

3. **Check logs**
   ```bash
   # Backend
   tail -50 /var/www/rentapplicaiton/backend/storage/logs/laravel.log
   
   # Frontend
   pm2 logs rentapp-frontend --lines 50
   ```

4. **Verify API connectivity**
   ```bash
   curl -I http://localhost/api/v1/health
   ```

---

## üìö Documentation Files

- **Root User Guide**: `/var/www/rentapplicaiton/ROOT_USER_GUIDE.md`
- **Prevention Guide**: `/var/www/rentapplicaiton/PREVENTION_GUIDE.md`
- **Issue Summary**: `/var/www/rentapplicaiton/ISSUE_SUMMARY.md`
- **This Memory File**: `/var/www/rentapplicaiton/.cursor-memory.md`

---

## ‚ö° Quick Reference

### Before Making Changes
1. Check current permissions: `check-laravel-owner`
2. Note what you're changing

### While Making Changes
1. Use `sudo -u www-data` for Laravel commands
2. Use `sudo -u www-data` for file operations in storage/
3. Wrap logging in try-catch

### After Making Changes
1. **ALWAYS** fix permissions if worked as root: `after-root-work`
2. Verify ownership: `check-laravel-owner`
3. Test the changes
4. Check logs if issues occur

---

## üéØ Remember

1. **Permissions are critical** - Always fix after root work
2. **Error handling should be graceful** - Don't break requests for logging failures
3. **Always use www-data** for application operations
4. **Check before, during, and after** working as root
5. **Document issues and solutions** for future reference

---

**Last Updated**: 2025-12-12  
**Maintained By**: AI Assistant (Cursor)  
**Purpose**: Persistent memory for project guidelines and best practices
