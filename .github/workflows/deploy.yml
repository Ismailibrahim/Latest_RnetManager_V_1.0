name: üöÄ Deploy to VPS via SSH

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      APP_DIRECTORY: /var/www/webapp
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_HOST: ${{ secrets.SSH_HOST }}
      APP_URL: ${{ secrets.APP_URL }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîë Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üîç Verify SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" "echo '‚úÖ SSH connection successful'"

      - name: üìã Pre-deployment checks
        continue-on-error: true
        run: |
          ssh -o StrictHostKeyChecking=no "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" <<'EOF'
          set +e  # Don't exit on error
          APP_DIR="/var/www/webapp"

          echo "üîç Running pre-deployment checks..."

          if [ ! -d "$APP_DIR" ]; then
            echo "‚ùå Error: App directory not found: $APP_DIR"
            exit 1
          fi

          # Basic checks only (skip script execution to avoid permission issues)
          AVAILABLE=$(df "$APP_DIR" | tail -1 | awk '{print $4}')
          if [ "$AVAILABLE" -lt 1048576 ]; then
            echo "‚ö†Ô∏è  Warning: Low disk space (less than 1GB free)"
          else
            echo "‚úÖ Disk space check passed: $(($AVAILABLE / 1024 / 1024))GB free"
          fi

          if [ ! -f "$APP_DIR/deploy.sh" ]; then
            echo "‚ö†Ô∏è  Warning: deploy.sh not found, will be copied from config/deploy/deploy.sh"
          else
            echo "‚úÖ deploy.sh found"
          fi

          echo "‚úÖ Basic pre-deployment checks completed"
          EOF

      - name: üì¶ Copy code to server
        run: |
          echo "üì§ Syncing code to server (this will update deploy.sh)..."
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.next' \
            --exclude='backend/vendor' \
            --exclude='backend/storage/logs' \
            --exclude='backups' \
            -e "ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=15 -o ServerAliveCountMax=20" \
            ./ "${{ env.SSH_USER }}@${{ env.SSH_HOST }}:/var/www/webapp/"
          echo "‚úÖ Code sync complete"
          
          # Verify deploy.sh was updated (fail fast if not)
          echo "üîç Verifying deploy.sh was updated..."
          ssh -o StrictHostKeyChecking=no "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" <<'EOF'
          set -e
          APP_DIR="/var/www/webapp"
          TARGET="$APP_DIR/deploy.sh"

          if [ ! -f "$TARGET" ]; then
            echo "‚ùå ERROR: deploy.sh not found at $TARGET"
            exit 1
          fi

          missing=0
          check_pattern() {
            PATTERN="$1"
            DESCRIPTION="$2"
            if grep -q "$PATTERN" "$TARGET"; then
              echo "   ‚úÖ $DESCRIPTION"
            else
              echo "   ‚ùå $DESCRIPTION (pattern '$PATTERN' missing)"
              missing=1
            fi
          }

          check_pattern "DEFAULTS TO TRUE FOR SAFETY" "Backup defaults disabled"
          check_pattern "TEMP_SWAP_FILE" "Temporary swap logic"
          check_pattern "Backup SKIPPED (automated deployment detected)" "Automated backup skip message"

          if [ "$missing" -ne 0 ]; then
            echo "‚ùå ERROR: deploy.sh is outdated. Deployment aborted."
            exit 1
          fi

          echo "‚úÖ deploy.sh verification passed"
          EOF

      - name: üöÄ Deploy to VPS
        timeout-minutes: 30
        run: |
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=15 -o ServerAliveCountMax=20 -o TCPKeepAlive=yes "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" <<'EOF'
          set -e
          APP_DIR="/var/www/webapp"

          echo "üìÇ Navigating to $APP_DIR"
          cd "$APP_DIR" || exit 1

          # CRITICAL: Verify deploy.sh has the latest backup-disable logic
          # This MUST be present or backup will run and cause SSH timeout
          echo "üîç Verifying deploy.sh has latest backup-disable logic..."
          
          # Wait a moment for rsync to complete (if it's still running)
          sleep 1
          
          # Check for the critical backup disable flag
          if ! grep -q "DISABLE_BACKUP_FOR_AUTOMATED_DEPLOYMENT" "$APP_DIR/deploy.sh" 2>/dev/null; then
            echo "‚ùå CRITICAL ERROR: deploy.sh is outdated (missing DISABLE_BACKUP_FOR_AUTOMATED_DEPLOYMENT)"
            echo "This means rsync didn't update it properly!"
            echo "The script will create a backup which will cause SSH timeout!"
            echo ""
            echo "File location: $APP_DIR/deploy.sh"
            echo "File exists: $([ -f "$APP_DIR/deploy.sh" ] && echo 'YES' || echo 'NO')"
            echo "File size: $(stat -c%s "$APP_DIR/deploy.sh" 2>/dev/null || echo 'unknown') bytes"
            echo ""
            echo "First 50 lines of deploy.sh:"
            head -50 "$APP_DIR/deploy.sh" || true
            echo ""
            echo "Searching for backup-related code:"
            grep -n "Creating backup\|üíæ Creating\|backup.*tar" "$APP_DIR/deploy.sh" | head -5 || true
            echo ""
            echo "‚ùå DEPLOYMENT ABORTED - Script is outdated and will cause backup to run!"
            exit 1
          fi
          
          # Also verify it has the skip logic
          if ! grep -q "Backup SKIPPED" "$APP_DIR/deploy.sh" 2>/dev/null; then
            echo "‚ùå CRITICAL ERROR: deploy.sh missing backup skip logic"
            exit 1
          fi
          
          echo "‚úÖ Verified deploy.sh has latest backup-disable logic"
          echo "   - Has DISABLE_BACKUP_FOR_AUTOMATED_DEPLOYMENT flag"
          echo "   - Has backup skip logic"

          echo "üöÄ Running deployment script..."
          echo "‚ÑπÔ∏è  Note: Code already synced from GitHub Actions, skipping git pull and backup"
          
          # Export environment variables and ensure they're available to the script
          export APP_DIRECTORY="$APP_DIR"
          export DEPLOY_ENV="production"
          export SKIP_GIT_PULL="true"
          export SKIP_BACKUP="true"
          export DISABLE_BACKUP_FOR_AUTOMATED_DEPLOYMENT="true"
          export ENABLE_BACKUP="false"
          
          echo "DEBUG: Before script - SKIP_BACKUP=$SKIP_BACKUP, SKIP_GIT_PULL=$SKIP_GIT_PULL"
          echo "DEBUG: Script location: $APP_DIR/deploy.sh"
          
          # Run deploy script with environment variables explicitly passed
          # CRITICAL: Pass variables both via export AND env command to ensure they're available
          DISABLE_BACKUP_FOR_AUTOMATED_DEPLOYMENT="true" ENABLE_BACKUP="false" SKIP_BACKUP="true" SKIP_GIT_PULL="true" APP_DIRECTORY="$APP_DIR" DEPLOY_ENV="production" bash "$APP_DIR/deploy.sh" || {
            echo "‚ùå Deployment script failed"
            exit 1
          }

          echo "‚úÖ Deployment script completed"
          EOF

      - name: üè• Health check
        run: |
          ssh -o StrictHostKeyChecking=no "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" <<'EOF'
          set -e
          APP_DIR="/var/www/webapp"
          APP_URL="${APP_URL:-}"
          if [ -z "$APP_URL" ]; then
            APP_URL="http://${SSH_HOST}"
          fi

          echo "üè• Running health checks..."
          echo "Health check URL: $APP_URL/api/v1/health"
          sleep 5

          if command -v curl >/dev/null 2>&1; then
            HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL/api/v1/health" || echo "000")
            if [ "$HEALTH_RESPONSE" = "200" ]; then
              echo "‚úÖ Backend health check passed (HTTP $HEALTH_RESPONSE)"
            else
              echo "‚ö†Ô∏è  Backend health check returned HTTP $HEALTH_RESPONSE"
            fi
          else
            echo "‚ö†Ô∏è  curl not available, skipping health check"
          fi

          if systemctl is-active --quiet nginx 2>/dev/null; then
            echo "‚úÖ Nginx is running"
          else
            echo "‚ö†Ô∏è  Nginx status unknown"
          fi

          if systemctl is-active --quiet php8.2-fpm 2>/dev/null || systemctl is-active --quiet php8.3-fpm 2>/dev/null; then
            echo "‚úÖ PHP-FPM is running"
          else
            echo "‚ö†Ô∏è  PHP-FPM status unknown"
          fi

          if command -v pm2 >/dev/null 2>&1; then
            if pm2 list | grep -q "rentapp-frontend"; then
              echo "‚úÖ PM2 process (rentapp-frontend) is running"
            else
              echo "‚ö†Ô∏è  PM2 process (rentapp-frontend) not found"
            fi
          else
            echo "‚ö†Ô∏è  PM2 not installed or not in PATH"
          fi

          echo "‚úÖ Health checks completed"
          EOF

      - name: ‚úÖ Deployment status
        run: |
          echo "üéâ Deployment workflow completed!"
          APP_URL="${{ env.APP_URL }}"
          if [ -z "$APP_URL" ]; then
            APP_URL="http://${{ env.SSH_HOST }}"
          fi
          echo "Check your VPS: $APP_URL"
          echo "Health endpoint: $APP_URL/api/v1/health"
