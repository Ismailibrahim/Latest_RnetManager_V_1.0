name: üöÄ Deploy to VPS via SSH

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      APP_DIRECTORY: /var/www/webapp
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_HOST: ${{ secrets.SSH_HOST }}
      APP_URL: ${{ secrets.APP_URL }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîë Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üîç Verify SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" "echo '‚úÖ SSH connection successful'"

      - name: üìã Pre-deployment checks
        continue-on-error: true
        run: |
          ssh -o StrictHostKeyChecking=no "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" <<'EOF'
          set +e  # Don't exit on error
          APP_DIR="/var/www/webapp"

          echo "üîç Running pre-deployment checks..."

          if [ ! -d "$APP_DIR" ]; then
            echo "‚ùå Error: App directory not found: $APP_DIR"
            exit 1
          fi

          # Basic checks only (skip script execution to avoid permission issues)
          AVAILABLE=$(df "$APP_DIR" | tail -1 | awk '{print $4}')
          if [ "$AVAILABLE" -lt 1048576 ]; then
            echo "‚ö†Ô∏è  Warning: Low disk space (less than 1GB free)"
          else
            echo "‚úÖ Disk space check passed: $(($AVAILABLE / 1024 / 1024))GB free"
          fi

          if [ ! -f "$APP_DIR/deploy.sh" ]; then
            echo "‚ö†Ô∏è  Warning: deploy.sh not found, will be copied from config/deploy/deploy.sh"
          else
            echo "‚úÖ deploy.sh found"
          fi

          echo "‚úÖ Basic pre-deployment checks completed"
          EOF

      - name: üöÄ Deploy to VPS
        timeout-minutes: 20
        run: |
          ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -o ServerAliveCountMax=10 -o TCPKeepAlive=yes "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" <<'EOF'
          set +e  # Don't exit on error for backup
          APP_DIR="/var/www/webapp"
          BACKUP_DIR="$APP_DIR/backups"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)

          echo "üìÇ Navigating to $APP_DIR"
          cd "$APP_DIR" || exit 1

          mkdir -p "$BACKUP_DIR"

          echo "üíæ Creating backup (this may take a few minutes)..."
          if [ -d "$APP_DIR/backend" ] && [ -d "$APP_DIR/frontend" ]; then
            # Create backup with more exclusions to make it faster
            # Run in background with nohup to prevent SSH disconnection issues
            nohup timeout 180 tar -czf "$BACKUP_DIR/backup_$TIMESTAMP.tar.gz" \
              --exclude="$APP_DIR/backups" \
              --exclude="$APP_DIR/node_modules" \
              --exclude="$APP_DIR/backend/vendor" \
              --exclude="$APP_DIR/backend/storage/logs/*" \
              --exclude="$APP_DIR/backend/storage/framework/cache/*" \
              --exclude="$APP_DIR/backend/storage/framework/sessions/*" \
              --exclude="$APP_DIR/backend/storage/framework/views/*" \
              --exclude="$APP_DIR/frontend/.next" \
              --exclude="$APP_DIR/frontend/node_modules" \
              --exclude="$APP_DIR/frontend/.cache" \
              --exclude="*.log" \
              --exclude="*.tmp" \
              . > "$BACKUP_DIR/backup_${TIMESTAMP}.log" 2>&1 &
            
            BACKUP_PID=$!
            echo "Backup process started (PID: $BACKUP_PID)"
            
            # Wait for backup with timeout, but don't fail deployment if it times out
            wait $BACKUP_PID 2>/dev/null
            BACKUP_EXIT=$?
            
            if [ $BACKUP_EXIT -eq 0 ]; then
              echo "‚úÖ Backup created: backup_$TIMESTAMP.tar.gz"
            else
              echo "‚ö†Ô∏è  Backup creation had issues (exit code: $BACKUP_EXIT), but continuing with deployment..."
              # Check if backup file was created anyway
              if [ -f "$BACKUP_DIR/backup_$TIMESTAMP.tar.gz" ]; then
                echo "‚úÖ Backup file exists despite error"
              fi
            fi
          else
            echo "‚ö†Ô∏è  Backend or frontend directory not found, skipping backup"
          fi
          
          set -e  # Re-enable exit on error for deployment

          if [ ! -f "$APP_DIR/deploy.sh" ]; then
            if [ -f "$APP_DIR/config/deploy/deploy.sh" ]; then
              cp "$APP_DIR/config/deploy/deploy.sh" "$APP_DIR/deploy.sh"
              chmod +x "$APP_DIR/deploy.sh"
            else
              echo "‚ùå Error: deploy.sh not found"
              exit 1
            fi
          fi

          echo "üöÄ Running deployment script..."
          export APP_DIRECTORY="$APP_DIR"
          export DEPLOY_ENV="production"
          bash "$APP_DIR/deploy.sh"

          echo "‚úÖ Deployment script completed"
          EOF

      - name: üè• Health check
        run: |
          ssh -o StrictHostKeyChecking=no "${{ env.SSH_USER }}@${{ env.SSH_HOST }}" <<'EOF'
          set -e
          APP_DIR="/var/www/webapp"
          APP_URL="${APP_URL:-}"
          if [ -z "$APP_URL" ]; then
            APP_URL="http://${SSH_HOST}"
          fi

          echo "üè• Running health checks..."
          echo "Health check URL: $APP_URL/api/v1/health"
          sleep 5

          if command -v curl >/dev/null 2>&1; then
            HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL/api/v1/health" || echo "000")
            if [ "$HEALTH_RESPONSE" = "200" ]; then
              echo "‚úÖ Backend health check passed (HTTP $HEALTH_RESPONSE)"
            else
              echo "‚ö†Ô∏è  Backend health check returned HTTP $HEALTH_RESPONSE"
            fi
          else
            echo "‚ö†Ô∏è  curl not available, skipping health check"
          fi

          if systemctl is-active --quiet nginx 2>/dev/null; then
            echo "‚úÖ Nginx is running"
          else
            echo "‚ö†Ô∏è  Nginx status unknown"
          fi

          if systemctl is-active --quiet php8.2-fpm 2>/dev/null || systemctl is-active --quiet php8.3-fpm 2>/dev/null; then
            echo "‚úÖ PHP-FPM is running"
          else
            echo "‚ö†Ô∏è  PHP-FPM status unknown"
          fi

          if command -v pm2 >/dev/null 2>&1; then
            if pm2 list | grep -q "rentapp-frontend"; then
              echo "‚úÖ PM2 process (rentapp-frontend) is running"
            else
              echo "‚ö†Ô∏è  PM2 process (rentapp-frontend) not found"
            fi
          else
            echo "‚ö†Ô∏è  PM2 not installed or not in PATH"
          fi

          echo "‚úÖ Health checks completed"
          EOF

      - name: ‚úÖ Deployment status
        run: |
          echo "üéâ Deployment workflow completed!"
          APP_URL="${{ env.APP_URL }}"
          if [ -z "$APP_URL" ]; then
            APP_URL="http://${{ env.SSH_HOST }}"
          fi
          echo "Check your VPS: $APP_URL"
          echo "Health endpoint: $APP_URL/api/v1/health"
