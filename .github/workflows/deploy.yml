name: üöÄ Deploy to VPS via SSH

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîë Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üîç Verify SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "echo '‚úÖ SSH connection successful'"

      - name: üìã Pre-deployment checks
        run: |
          ssh -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e
          
          APP_DIR="${APP_DIRECTORY:-/var/www/webapp}"
          
          echo "üîç Running pre-deployment checks..."
          
          # Check if app directory exists
          if [ ! -d "$APP_DIR" ]; then
            echo "‚ùå Error: App directory not found: $APP_DIR"
            exit 1
          fi
          
          # Check disk space (at least 1GB free)
          AVAILABLE=$(df "$APP_DIR" | tail -1 | awk '{print $4}')
          if [ "$AVAILABLE" -lt 1048576 ]; then
            echo "‚ö†Ô∏è  Warning: Low disk space (less than 1GB free)"
          fi
          
          # Check if deploy script exists
          if [ ! -f "$APP_DIR/deploy.sh" ]; then
            echo "‚ö†Ô∏è  Warning: deploy.sh not found, will be created from config/deploy/deploy.sh"
          fi
          
          echo "‚úÖ Pre-deployment checks passed"
          EOF

      - name: üöÄ Deploy to VPS
        id: deploy
        run: |
          ssh -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e
          
          APP_DIR="${APP_DIRECTORY:-/var/www/webapp}"
          BACKUP_DIR="$APP_DIR/backups"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          echo "üìÇ Navigating to $APP_DIR"
          cd "$APP_DIR" || exit 1
          
          # Create backup directory
          mkdir -p "$BACKUP_DIR"
          
          # Backup current deployment (for rollback)
          echo "üíæ Creating backup..."
          if [ -d "$APP_DIR/backend" ] && [ -d "$APP_DIR/frontend" ]; then
            tar -czf "$BACKUP_DIR/backup_$TIMESTAMP.tar.gz" \
              --exclude="$APP_DIR/backups" \
              --exclude="$APP_DIR/node_modules" \
              --exclude="$APP_DIR/backend/vendor" \
              --exclude="$APP_DIR/backend/storage/logs/*" \
              --exclude="$APP_DIR/frontend/.next" \
              . 2>/dev/null || true
            echo "‚úÖ Backup created: backup_$TIMESTAMP.tar.gz"
          fi
          
          # Ensure deploy script exists and is executable
          if [ ! -f "$APP_DIR/deploy.sh" ]; then
            if [ -f "$APP_DIR/config/deploy/deploy.sh" ]; then
              cp "$APP_DIR/config/deploy/deploy.sh" "$APP_DIR/deploy.sh"
              chmod +x "$APP_DIR/deploy.sh"
            else
              echo "‚ùå Error: deploy.sh not found"
              exit 1
            fi
          fi
          
          # Run deployment script
          echo "üöÄ Running deployment script..."
          export APP_DIRECTORY="$APP_DIR"
          bash "$APP_DIR/deploy.sh" || {
            echo "‚ùå Deployment failed!"
            exit 1
          }
          
          echo "‚úÖ Deployment script completed"
          EOF

      - name: üè• Health check
        run: |
          ssh -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << EOF
          set -e
          
          APP_DIR="${APP_DIRECTORY:-/var/www/webapp}"
          APP_URL="${{ secrets.APP_URL }}"
          if [ -z "$APP_URL" ]; then
            APP_URL="http://${{ secrets.SSH_HOST }}"
          fi
          
          echo "üè• Running health checks..."
          echo "Health check URL: $APP_URL/api/v1/health"
          
          # Wait a bit for services to stabilize
          sleep 5
          
          # Check backend health endpoint
          if command -v curl >/dev/null 2>&1; then
            HEALTH_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL/api/v1/health" || echo "000")
            if [ "$HEALTH_RESPONSE" = "200" ]; then
              echo "‚úÖ Backend health check passed (HTTP $HEALTH_RESPONSE)"
            else
              echo "‚ö†Ô∏è  Backend health check returned HTTP $HEALTH_RESPONSE"
            fi
          else
            echo "‚ö†Ô∏è  curl not available, skipping health check"
          fi
          
          # Check if services are running
          if systemctl is-active --quiet nginx 2>/dev/null; then
            echo "‚úÖ Nginx is running"
          else
            echo "‚ö†Ô∏è  Nginx status unknown (may not be managed by systemd)"
          fi
          
          echo "‚úÖ Health checks completed"
          EOF

      - name: ‚úÖ Deployment status
        run: |
          echo "üéâ Deployment workflow completed successfully!"
          echo "Check your VPS at: ${{ secrets.SSH_HOST }}"
          APP_URL="${{ secrets.APP_URL }}"
          if [ -z "$APP_URL" ]; then
            APP_URL="http://${{ secrets.SSH_HOST }}"
          fi
          echo "Health endpoint: $APP_URL/api/v1/health"

